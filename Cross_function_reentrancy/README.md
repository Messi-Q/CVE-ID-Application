# Cross_function_reentrancy

## Vendor
Cross-function Reentrancy

## Vulnerability Type
Cross Function Reentrancy Bug

## Abstract
We found a complex but common cross-function attack scenario in Ethereum smart contracts, where an attacker can undesirably reenter a function to steal money. The attack scenario can be abstracted as: (1) given a contract *Vulnerable* containing two transfer functions *getBonus* and *withdraw*, which can transfer Ether (cryptocurrency in Ethreum) to another contract. (2) Once function *getBonus* of contract Vulnerable is called to send some Ether to a contract Attacker, the *fallback* function of *Attacker* is automatically invoked. (3) In its *fallback* function, *Attacker* calls function *withdraw*, which will undesirably transfer money to *Attacker* again. While reentrancy exploiting one single function has been well studied, reentrancy vulnerability using cross-function has not yet been issued.

## Details
We present the specific steps for a specific reentrancy attack as shown in the figure below.

<div align=center><img width="520" height="240" src="./images/cross-function.png"/></div>

Contract *Vulnerable* containing two transfer functions *getBonus* and *withdraw*.
* *getBonus* declares one transfer operation, representing the recipient can claim the bonus.
* *withdraw* declares another transfer operation, making the recipient can withdraw his asset.

```
contract Vulnerable{
  ...
  
  // Each recipient should only be able to claim the bonus once
  function getBonus(address recipient) public {
      uint amountToWithdraw = rewardsForA[recipient];
      rewardsForA[recipient] = 0;
      if (recipient.call.value(amountToWithdraw)() == false) {
              throw;
      }
      totalbalance -= amountToWithdraw;
  }

  function withdraw(uint _amount) public {   
    msg.sender.call.value(_amount)();
    userBalances[msg.sender] -= _amount;
    totalbalance -= _amount;
  }
}
```


**Step 1** The contract *Attacker* uses the function *attack* to call the function *getBonus* to obtain the bonus (Ether or money), aiming to initiate the attack.


## Exploit


## Conclusion


## Reference

